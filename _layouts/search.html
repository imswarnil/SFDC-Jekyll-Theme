---
layout: default
---
<div class="search-layout sf-container">

  <header class="search-header">
    <h1 class="sf-h1">{{ page.title }}</h1>
    <p class="sf-text--large sf-text--muted">{{ page.subtitle | default: page.excerpt }}</p>
  </header>

  <form class="search-form" id="search-form" action="" onsubmit="return false;">
    <i class="ph-bold ph-magnifying-glass search-form__icon"></i>
    <i class="ph-bold ph-spinner-gap search-form__spinner" id="search-spinner"></i>
    <input class="search-form__input" id="search-input" type="search" name="search" placeholder="Search the Trail..." autocomplete="off" />
  </form>

  <div class="search-results" id="search-results-container">
    <!-- Results will be injected here -->
  </div>

  <noscript>
    <div class="search-status">
      <i class="ph-bold ph-warning"></i>
      <p>Please enable JavaScript to use the search form.</p>
    </div>
  </noscript>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const endpoint = '{{ "/assets/search.json" | relative_url }}';
  let pages = [];
  let isFetching = true;

  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results-container');
  
  const showLoading = (isLoading) => {
    searchForm.classList.toggle('is-searching', isLoading);
  };

  // --- Initial state ---
  showLoading(true);
  resultsContainer.innerHTML = `
    <div class="search-status">
      <i class="ph-bold ph-cloud-arrow-down"></i>
      <p>Loading search index...</p>
    </div>`;

  // --- Fetch Data ---
  fetch(endpoint)
    .then(blob => blob.json())
    .then(data => {
      pages = data.filter(item => item !== null && typeof item === 'object');
      isFetching = false;
      showLoading(false);
      displayResults.call({ value: searchInput.value }); // Display initial prompt or results if user typed fast
    })
    .catch(err => {
      console.error('Error fetching search data:', err);
      showLoading(false);
      resultsContainer.innerHTML = `<div class="search-status"><i class="ph-bold ph-x-circle"></i><h3>Error Loading Search</h3></div>`;
    });

  function getIconForType(url) {
    if (url.includes('/docs/')) return 'ph-book-open';
    if (url.includes('/blog/') || url.match(/\/\d{4}\/\d{2}\/\d{2}\//)) return 'ph-article';
    if (url.includes('/projects/')) return 'ph-rocket-launch';
    return 'ph-file';
  }
  
  function findResults(term, data) {
    if (!term) return [];
    const regex = new RegExp(term, 'gi');
    return data
      .map(item => {
        const titleMatch = item.title.match(regex);
        const contentMatch = item.content.match(regex);
        if (!titleMatch && !contentMatch) return null;
        
        // Create highlighted versions for display
        const highlightedTitle = item.title.replace(regex, (match) => `<mark>${match}</mark>`);
        
        // Create a smarter excerpt with the first match
        let highlightedExcerpt = '';
        const excerptText = item.excerpt || item.content.substring(0, 150);
        const matchIndex = excerptText.toLowerCase().indexOf(term.toLowerCase());

        if (matchIndex > -1) {
          const startIndex = Math.max(0, matchIndex - 30); // show some context before
          highlightedExcerpt = (startIndex > 0 ? '...' : '') + 
                                excerptText.substring(startIndex, startIndex + 120).replace(regex, (match) => `<mark>${match}</mark>`) + 
                                '...';
        } else {
          highlightedExcerpt = excerptText.substring(0, 120) + '...';
        }

        return { ...item, highlightedTitle, highlightedExcerpt };
      })
      .filter(item => item !== null);
  }

  function displayResults() {
    if (isFetching) return; // Don't do anything if index hasn't loaded
    
    const searchTerm = this.value;
    
    if (!searchTerm || searchTerm.length < 2) {
      resultsContainer.innerHTML = `<div class="search-status"><i class="ph-bold ph-keyboard"></i><p>Start typing to find what you're looking for.</p></div>`;
      return;
    }

    const resultsArray = findResults(searchTerm, pages);
    
    let html = '';
    if (resultsArray.length > 0) {
      html += `<div class="search-results__header"><h2 class="search-results__title">Results</h2><span class="search-results__count">${resultsArray.length} found</span></div>`;
      html += '<ul class="search-results__list">';
      html += resultsArray.map(item => {
        const icon = getIconForType(item.url);
        return `
          <li>
            <a href="${item.url}" class="search-result-item">
              <article>
                <i class="ph-bold ${icon} search-result-item__icon"></i>
                <div class="search-result-item__content">
                  <h3 class="search-result-item__title">${item.highlightedTitle}</h3>
                  <p class="search-result-item__excerpt">${item.highlightedExcerpt}</p>
                </div>
              </article>
            </a>
          </li>`;
      }).join('');
      html += '</ul>';
    } else {
      html = `<div class="search-status"><i class="ph-bold ph-binoculars"></i><h3>No Results Found</h3><p>We couldn't find anything matching "<strong>${searchTerm}</strong>". Try another search.</p></div>`;
    }
    resultsContainer.innerHTML = html;
  }

  searchInput.addEventListener('keyup', displayResults);
});
</script>