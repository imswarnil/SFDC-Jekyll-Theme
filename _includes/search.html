<div class="page-search-layout">

  <!-- The Search Form -->
  <form class="page-search-form" action="" role="search" onsubmit="return false;">
    <label for="search-input" class="sf-sr-only">Search term:</label>
    <i class="ph-bold ph-magnifying-glass page-search-form__icon"></i>
    <input class="page-search-input" id="search-input" type="search" name="search" placeholder="e.g. Alembic or Salesforce" autocomplete="off" />
  </form>

  <!-- The Results List -->
  <ul class="page-search-results" id="results-list">
      <!-- Live search results will be injected here by JavaScript -->
  </ul>

</div>

<!-- Self-Contained JavaScript -->
<script type="text/javascript" src="{{ "/assets/scripts/fetch.js" | relative_url }}"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', () => {
    const endpoint = '{{ "/assets/search.json" | relative_url }}';
    const pages = [];

    fetch(endpoint)
      .then(blob => blob.json())
      .then(data => pages.push(...data))
      .catch(err => console.error("Error fetching search data:", err));

    function findResults(termToMatch, pages) {
      if (!termToMatch) return [];
      return pages.filter(item => {
        const regex = new RegExp(termToMatch, 'gi');
        return item.title.match(regex) || item.content.match(regex);
      });
    }

    function displayResults() {
      const resultsArray = findResults(this.value, pages);
      const searchTerm = this.value;

      if (searchTerm.trim() === '') {
        resultsList.innerHTML = ''; // Clear results if input is empty
        return;
      }

      if (resultsArray.length === 0) {
        // Display the "No Results" state
        resultsList.innerHTML = `
          <div class="page-search-no-results">
            <i class="ph-bold ph-files"></i>
            <h3 class="sf-h3">No Results Found</h3>
            <p>Sorry, we couldn't find anything matching "${searchTerm}". Try a different search term.</p>
          </div>`;
      } else {
        // Display the result cards
        const html = resultsArray.map(item => {
          // Use a default excerpt if the real one is missing
          const excerpt = item.excerpt ? item.excerpt.replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : 'No description available.';
          return `
            <li>
              <a href="${item.url}" class="page-search-result-card">
                <div class="sf-card__body">
                  <h4 class="sf-h4 page-search-result-card__title">${item.title}</h4>
                  <p class="page-search-result-card__excerpt">${excerpt}</p>
                </div>
              </a>
            </li>`;
        }).join('');
        resultsList.innerHTML = html;
      }
    }

    const field = document.getElementById('search-input');
    const resultsList = document.getElementById('results-list');

    if (field && resultsList) {
      field.addEventListener('keyup', displayResults);
      field.closest('form').addEventListener('submit', event => event.preventDefault());
    }
  });
</script>

<noscript>
  <div class="sf-card">
    <div class="sf-card__body typeset">
      <p>Please enable JavaScript to use the search form.</p>
    </div>
  </div>
</noscript>